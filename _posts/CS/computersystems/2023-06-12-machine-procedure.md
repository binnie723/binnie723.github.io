---
title:  "Machine-level í”„ë¡œê·¸ë˜ë° : Memory Layout, Buffer Overflow" 

categories:
  - Computer Systems
tags:
  - [memory, stack, buffer]
toc: true
toc_sticky: true
use_math: true
date: 2023-06-12
last_modified_at: 2022-06-12
---
<br/> 

## Memory Layout

---

ì´ë²ˆ ë‹¨ì›ì€ ë©”ëª¨ë¦¬ì˜ êµ¬ì¡°ì™€ ìŠ¤íƒì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ì— ëŒ€í•œ ë‚´ìš©ì´ë‹¤. 

### x86-64 Linux Memory Layout

í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¤ë©´ OSëŠ” ì‹¤í–‰ íŒŒì¼ì„ ë©”ëª¨ë¦¬ì— ë¡œë“œí•˜ë©´ì„œ, ì—¬ëŸ¬ ê°œì˜ ë…ë¦½ì ì¸ ì˜ì—­ì„ ìƒì„±í•œë‹¤. í• ë‹¹ë˜ëŠ” ë©”ëª¨ë¦¬ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. 

![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/3a71513c-060a-4a2c-8b23-2782a44de918){: width="480px"}

ex. ì‹¤ì œë¡œ í• ë‹¹ë˜ëŠ” ì˜ˆì‹œë¥¼ ë‚˜íƒ€ë‚¸ ê·¸ë¦¼ 

![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/7b79e34f-63cd-499f-95e4-d7ec7a62bfbe){: width="480px"}
<br/>
## Buffer Overflow

---

### Memory Referencing Bug : segfault

ì•„ë˜ ì½”ë“œëŠ” buffer overflowë¥¼ ë°œìƒì‹œí‚¤ëŠ” ì˜ˆì‹œ ì½”ë“œì´ë‹¤. 

`fun(i)` í•¨ìˆ˜ëŠ” a[i]ì— ì ‘ê·¼í•´ì„œ ë°°ì—´ì˜ ê°’ì„ í• ë‹¹í•˜ê³ , ë¦¬í„´ ê°’ìœ¼ë¡œ ì‹¤ìˆ˜ ê°’ dë¥¼ ë°˜í™˜í•œë‹¤. 

![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/4df038b0-d1ed-459b-9c33-66d519733d16){: width="480px"}

ë§Œì•½ iê°€ 0 ë˜ëŠ” 1ì¸ ê²½ìš°ì—ëŠ” dì˜ ê°’ì„ 3.14ë¡œ ì •ìƒ ì¶œë ¥í•˜ì§€ë§Œ, 2 ì´ìƒì¸ ê²½ìš°ì—ëŠ” aë°°ì—´ì˜ ì¸ë±ìŠ¤ ë²”ìœ„ë¥¼ ì´ˆê³¼í•˜ê²Œ ë˜ë©´ì„œ memory reference bugë¥¼ ìœ ë°œí•œë‹¤. 

![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/198ea991-3927-4f78-935b-0cdcbe0e4b08){: width="480px"}

`i = 2,3` : a ë°°ì—´ì˜ ë²„í¼ë¥¼ ì´ˆê³¼í•˜ë©´ì„œ dì˜ ê°’ì„ overwrite

`i = 4` : stackì´ í• ë‹¹í•œ extra ê³µê°„ì— ì €ì¥, overwriteê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ

`i = 6` : iê°€ ë§ì´ í° ê²½ìš°, stackì˜ ë²”ìœ„ë¥¼ ì™„ì „íˆ ë²—ì–´ë‚˜ë©´ì„œ segfault ë°œìƒ

->  ì´ ì‹œì ë¶€í„° critical stateì´ë¼ê³  ë¶€ë¥¸ë‹¤. 


ğŸ‘©ğŸ»â€ğŸ’» Segmentation faultëŠ” í”„ë¡œê·¸ë¨ì— ì†í•˜ì§€ ì•Šì€ ë©”ëª¨ë¦¬ ìœ„ì¹˜ë¥¼ ì ‘ê·¼í•˜ë ¤ê³  í•  ë•Œ ë°œìƒí•˜ê²Œ ë¨. <br/>í•˜ì§€ë§Œ ëŸ°íƒ€ì„ ìŠ¤íƒì€ return addressë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ ì¶”ê°€ ê³µê°„ì„ í• ë‹¹í•˜ê¸° ë•Œë¬¸ì— ë°”ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ëŠ” ì•ŠìŒ.
{: .notice--primary}
<br/>
ì´ëŸ¬í•œ ìƒí™©ì„ **buffer overflow í˜„ìƒ**ì´ë¼ê³  í•œë‹¤. 

- ì¼ë°˜ì ì¸ í˜„ìƒì€ ì…ë ¥ stringì˜ ê¸¸ì´ë¥¼ ì œëŒ€ë¡œ í™•ì¸í•˜ì§€ ì•ŠëŠ” ê²½ìš°
    
    ìŠ¤íƒ ë‚´ì— ì •í•´ì§„ string ë°°ì—´ì˜ ë²”ìœ„ë¥¼ ì´ˆê³¼í•˜ëŠ” ì…ë ¥ì„ ë„£ê²Œ ë˜ë©´, ì¸ì ‘í•œ ë©”ëª¨ë¦¬ ì˜ì—­ì´ë‚˜ return addressë¥¼ overwriteí•˜ë©´ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. 
    
- **Stack Smashing** ê³µê²© ê°€ëŠ¥
    
    ì´ í˜„ìƒì„ ì•…ìš©í•´ì„œ í•´ì»¤ë“¤ì€ bufferì˜ ê²½ê³„ë¥¼ ì´ˆê³¼í•˜ëŠ” ì…ë ¥ì„ ì •êµí•˜ê²Œ ì¡°ì‘í•´ì„œ return addressë¥¼ ì•…ì˜ì ì¸ ì½”ë“œë¡œ ë®ì–´ ì”Œì›Œì„œ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆë‹¤. 
    
    -> ë”°ë¼ì„œ buffer overflowë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì„œ ì½”ë“œë¥¼ êµ¬ì„±í•´ì•¼ í•¨!
    
    - worms : ìì²´ì ìœ¼ë¡œ ì‹¤í–‰ê°€ëŠ¥í•œ ì•…ì„± ì†Œí”„íŠ¸ì›¨ì–´ë¡œ, ë„¤íŠ¸ì›Œí¬ë¡œ ìë™ ì „íŒŒ
    - viruses : ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸ í”„ë¡œê·¸ë¨ì— ì˜ì¡´í•´ì„œ ì „íŒŒë˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´

<br/>  
### Protection Mechanisms

buffer overflowë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•´ì„œëŠ” í¬ê²Œ ì„¸ ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤. 

1. **string ì…ë ¥ì„ ì œí•œí•˜ëŠ” Library routines**
    
    ex.  `fgets()`, `strncpy`, `scanf(%ns)`ë¥¼ ì‚¬ìš©í•´ì„œ ì½”ë“œë¥¼ êµ¬í˜„
    
    ![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/1ea4867f-e16b-4d48-9170-5f2fe0574b0d){: width="430px"}
    
2. **System-level Protection**
    
    ì½”ë“œ ìƒ êµ¬í˜„ì´ ì•„ë‹Œ, ì‹œìŠ¤í…œ ë‚´ë¶€ì—ì„œ ì•Œì•„ì„œ ë°©ì§€í•˜ë„ë¡ êµ¬ì„±í•˜ëŠ” ë°©ë²•ë“¤ë„ ìˆë‹¤.
    
    - **Address Space Layout Randomization (ASLR)**
        
        í”„ë¡œê·¸ë¨ì´ ì‹¤í–‰ë  ë•Œë§ˆë‹¤ stack ì˜ì—­ì´ random allocationë˜ê¸° ë•Œë¬¸ì— í•´ì»¤ë“¤ì€ ì£¼ì…í•œ exploit ì½”ë“œì˜ ìœ„ì¹˜(B)ë¥¼ ì˜ˆì¸¡í•˜ê¸° ì–´ë ¤ì›Œì§„ë‹¤.  
        
    - **Non-executable code segments**
        
        x86-64ë¶€í„° â€œexecuteâ€ ê¶Œí•œì´ ìƒê¸°ë©´ì„œ stack ì˜ì—­ ì¼ë¶€ì— ì‹¤í–‰ ê¶Œí•œì„ ì„¤ì •í•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤. í•´ì»¤ë“¤ì´ ì½”ë“œë¥¼ ì£¼ì…í•˜ë”ë¼ë„ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ì—†ë„ë¡ ë§Œë“ ë‹¤. 
        
        
        ğŸ‘©ğŸ»â€ğŸ’» í•˜ì§€ë§Œ ì´í›„ í•´ì»¤ë“¤ì€ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ì£¼ì…í•˜ì§€ ì•Šê³  ê¸°ì¡´ì˜ ì½”ë“œë¥¼ ë³€í˜•ì‹œí‚¤ëŠ” Return-Oriented Programming ê¸°ë²•ìœ¼ë¡œ ë°œì „
        {: .notice--primary}
        <br/>
3. **Stack Canaries** 
    
    ìŠ¤íƒì— ìˆëŠ” ë²„í¼ ë’¤ì— íŠ¹ì • ê°’ì„ ì§€ì •í•´ì„œ, í•¨ìˆ˜ë¥¼ ì¢…ë£Œ ì‹œì ì— í•´ë‹¹ ê°’ì´ corrupt ë˜ì—ˆëŠ”ì§€ ì‚¬ì „ì— í™•ì¸í•˜ëŠ” ë§¤ì»¤ë‹ˆì¦˜ì´ë‹¤. 
    
    `gcc -fstack-protector` í”Œë˜ê·¸ë¥¼ í†µí•´ canaryë¥¼ ì½”ë“œì— í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆë‹¤. 
    
    canaryê°€ ì‘ë™í•˜ëŠ” ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
    
    ![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/c3dbc823-084e-4579-98c6-d2620d3790d8){: width="440px"}
    
    ![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/ee8a03e3-e653-4ecb-9161-95d1d266e464){: width="440px"}
    
<br/>
### Attack Mechanisms : ROP

ëŒ€í‘œì ì¸ attacking ë§¤ì»¤ë‹ˆì¦˜ì€ ë‘ ê°€ì§€ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆë‹¤.

1. **Code injection**ì„ í†µí•œ ì•…ì„± ì½”ë“œ ì£¼ì…
    
    -> stack randomizationê³¼ ì‹¤í–‰ ê¶Œí•œì„ ì„¤ì •í•˜ëŠ” ë³´ì•ˆ ê¸°ë²• ë“±ìœ¼ë¡œ ë°©ì§€
    
2. **Return-Oriented Programming** : ê¸°ì¡´ì˜ ì½”ë“œë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•
    
    í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë‚˜ ê¸°ì¡´ ì½”ë“œì— ìˆëŠ” segmentì™€ gadgetì„ í™œìš©í•œë‹¤. í•´ì»¤ë“¤ì€ ì—¬ëŸ¬ ê°€ì ¯ë“¤ì„ ì—°ê²°í•´ì„œ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ì‚½ì…í•˜ì§€ ì•Šê³ ë„ ì›í•˜ëŠ” ëª…ë ¹ì„ ì‹¤í–‰í•œë‹¤. 
    

    ğŸ‘©ğŸ»â€ğŸ’» Gadgetì€ ret(return)ìœ¼ë¡œ ëë‚˜ëŠ” ëª…ë ¹ì–´ì˜ ë‚˜ì—´ í˜¹ì€ ì¡°ê°ì„ ë§í•œë‹¤. <br/>ì‹¤í–‰ íŒŒì¼ ì½”ë“œ ì˜ì—­ì—ì„œ ê°€ì ¯ì˜ ìœ„ì¹˜ëŠ” ì‹¤í–‰ë§ˆë‹¤ ì¼ì •í•˜ê²Œ ê³ ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— í•´ì»¤ê°€ ROP chainì„ êµ¬ì„±í•˜ê¸°ì— ì˜ ì‚¬ìš©ëœë‹¤.
    {: .notice--primary}  

    
    -> í•˜ì§€ë§Œ ì´ ê¸°ë²• ì—­ì‹œ stack canary ê¸°ë²•ìœ¼ë¡œ ë°©ì§€í•  ìˆ˜ ìˆë‹¤. 
    
<br/>
**Gadgetì„ í†µí•´ ë³€í˜•ë˜ëŠ” ì˜ˆì‹œ**

ab_plus_c í•¨ìˆ˜ì™€ setval í•¨ìˆ˜ì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì„ ì˜ë¼ì„œ gadgetì„ ìƒì„±í•˜ê³ , ì´ë“¤ì„ ì—°ê²°í•´ì„œ ì‹¤í–‰ì‹œì¼œì„œ ìƒˆë¡œìš´ ëª…ë ¹ì–´ë¥¼ ìƒì„±í•œë‹¤.  ab_plus_cì—ì„œ lea

ë¡œ ê³„ì‚°ëœ %raxì˜ ê°’ì„ ì´í›„ %rdiì— ë„£ëŠ” ê²ƒìœ¼ë¡œ ë³€í˜•ë˜ì—ˆë‹¤. 

![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/ba144bf1-d226-4856-8f69-6b10d1abc64e){: width="480px"}

ì •ë¦¬í•˜ë©´, ê° ì½”ë“œ ì˜ì—­ ì¤‘ì—ì„œ ë§ˆì§€ë§‰ ë¶€ë¶„ì— retì„ í¬í•¨í•˜ë„ë¡ ì˜ë¼ì„œ ìƒì„±í•œ gadgetë“¤ì„ ì¡°í•©í•˜ì—¬ ìƒˆë¡œìš´ ëª…ë ¹ì–´ë¥¼ ë§Œë“ ë‹¤. retì„ í†µí•´ ë‹¤ìŒ gadgetì˜ ì£¼ì†Œë¡œ ì í”„í•˜ê²Œ ë˜ê³  ì „ì²´ì ì¸ Gadget Chainì„ í˜•ì„±ëœë‹¤. 

![image](https://github.com/binnie723/binnie723.github.io/assets/86834982/ba5fc0bf-2c9a-4666-970f-2df1788a1959){: width="480px"}

<br/>  

<br/> <br/> 
@Computer Systems a programmerâ€™s perspective third edition ë‚´ìš©ì„ ì°¸ê³ í•¨
  
  
    
<br/><br/>
[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}
